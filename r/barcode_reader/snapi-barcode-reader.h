#ifndef SNAPI_BARCODE_READER_H
#define SNAPI_BARCODE_READER_H

#include "libusb.h"
//#include <QThread>
//#include <QTimer>
#include <QDebug>
#include <QQueue>
//#include <QAbstractEventDispatcher>
//#include <QFutureWatcher>
//#include <QtConcurrent/QtConcurrent>

#include "libusb-wrapper.h"
#include "barcode_msg.h"

#define INTR_LENGTH		1024

struct comm{
    uchar* comm;
    int size;
};
class snapi_barcode_reader: public QObject
{
    Q_OBJECT
public:
    //struct libusb_device_handle *dev_handle = nullptr;
    snapi_barcode_reader(uint16_t VID = 0x05E0, uint16_t PID = 0x1900, int iface = 0, int config = 1, int alt_config = 0, char EP_INTR = 0x81 );

protected:
    //async();
private:
    libusb_wrapper *usb_w;
    //QTimer *loop;
    static snapi_barcode_reader* m_instance;
    uint16_t VID = 0x05E0;
    uint16_t PID = 0x1900;
    char EP_INTR;

    //static
    //struct libusb_transfer *irq_transfer;
    //libusb_hotplug_callback_handle callback_handle;

    //struct libusb_transfer *bulk_transfer;
    int iface = 0;
    int config = 1;
    int alt_config;
    int completed=0;
    //timeval zero_tv { 0, 10000 };
    bool running = false;
    //unsigned char irqbuf[INTR_LENGTH];
    //unsigned char bulkbuf[INTR_LENGTH];

    //    uchar SNAPI_SETUP[4]         { 0x80, 0x02, 0x00, 0x01 };
    unsigned char SNAPI_INIT_1[32] {0x0D, 0x40, 0x00, 0x06, 0x00, 0x06, 0x20, 0x00, 0x04, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
unsigned char ENABLE_SCANNER[32] {0x06, 0x01};
    //=================================================
    unsigned char SNAPI_COMMAND_1[32] { 0x0D, 0x40, 0x00, 0x06, 0x00, 0x06, 0x02, 0x00, 0x4E, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_COMMAND_11[32] {0x0D, 0x40, 0x00, 0x10, 0x00, 0x10, 0x02, 0x00, 0x02, 0x15, 0x02, 0x16, 0x02, 0x17, 0x4E, 0x24, 0x4E, 0x27, 0x4E, 0x2B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_COMMAND_N [32] {0x0D, 0x40, 0x00, 0x04, 0x00, 0x04, 0x10, 0x00, 0x4E, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_COMMAND_NN [32] {0x0D, 0x40, 0x00, 0x04, 0x00, 0x04, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    //=================================================

    unsigned char SNAPI_COMMAND_magic_1[32] { 0x0D, 0x40, 0x00, 0x09, 0x00, 0x09, 0x05, 0x00, 0x4E, 0x2A, 0x42, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_COMMAND_magic_2 [32] { 0x0D, 0x40, 0x00, 0x06, 0x00, 0x06, 0x02, 0x00, 0x13, 0x8D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_COMMAND_magic_3[32] {0x0D, 0x40, 0x00, 0x09, 0x00, 0x09, 0x05, 0x00, 0x4E, 0x2A, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

    //=================================================
    //uchar SNAPI_BEEP[32]            { 0x0D, 0x40, 0x00, 0x09, 0x00, 0x09, 0x05, 0x00, 0x17, 0x70, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    unsigned char SNAPI_BEEP2[32] {0x04, 0x1B, 0x21, 0x09, 0x04, 0x02, 0x00, 0x00, 0x02, 0x00};

    unsigned char SNAPI_BARCODE_REQ[32] { 0x01, 0x22, 0x01, 0x00};
    unsigned char SNAPI_RET0[32] {0x01, 0x27, 0x01, 0x00};

    unsigned char SNAPI_IMAGE_JPG[32] {0x0B, 0x01, 0x02, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    unsigned char SNAPI_TRIGGER_MODE[32] {0x0B, 0x81, 0x02, 0x00, 0x8A, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    uchar SNAPI_PULL_TRIGGER[2]     { 0x0A, 0x01};
    uchar SNAPI_RELEASE_TRIGGER[2]  { 0x0A, 0x00};

    QQueue<comm> command_queue{};

    int status = 0;
    barcode_msg data{};
    QMap<int, QByteArray> message{};

    int set_param( unsigned char *_data, quint16 size, uint _timeout = 300);
    void parse_barcode( barcode_msg data );
    void parse_sn( barcode_msg data );
public slots:
    void deque();
    void start();
    void parseSNAPImessage( barcode_msg data );

private slots:
    void beep();
    void SNAPI_scaner_init( );

signals:
    void readyRead_barcode(QByteArray);

    void init_completed();
    void log(QString);
};

#endif // SNAPI_BARCODE_READER_H
